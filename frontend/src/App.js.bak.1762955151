import React, { useState, useEffect } from "react";
import "./App.css";

function IntroModal({ onClose }) {
  return (
    <div className="modal-backdrop">
      <div className="modal">
        <h2>Welcome ‚Äî Quick Instructions</h2>
        <ul>
          <li>Add a task on the left.</li>
          <li>Click a task to view or add comments on the right.</li>
          <li>Use Edit / Delete buttons on items. Toggle Dark mode top-right.</li>
        </ul>
        <button className="primary" onClick={onClose}>Got it</button>
      </div>
    </div>
  );
}

export default function App() {
  const [tasks, setTasks] = useState([]);
  const [newTask, setNewTask] = useState("");
  const [comments, setComments] = useState([]);
  const [selectedTask, setSelectedTask] = useState(null);
  const [newComment, setNewComment] = useState("");
  const [author, setAuthor] = useState("");
  const [darkMode, setDarkMode] = useState(false);
  const [showIntro, setShowIntro] = useState(() => {
    try { return localStorage.getItem("seenIntro") !== "1"; } catch { return true; }
  });
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [editingTaskTitle, setEditingTaskTitle] = useState("");
  const [editingCommentId, setEditingCommentId] = useState(null);
  const [editingCommentText, setEditingCommentText] = useState("");

  const API_URL = "http://127.0.0.1:5000/api";

  useEffect(() => {
    fetch(`${API_URL}/tasks`).then(r => r.json()).then(setTasks).catch(console.error);
  }, []);

  useEffect(() => {
    // put dark class on body so global CSS toggles correctly
    if (darkMode) document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }, [darkMode]);

  const addTask = async () => {
    if (!newTask.trim()) return;
    const res = await fetch(`${API_URL}/tasks`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ title: newTask })
    });
    const data = await res.json();
    if (res.ok) { setTasks(prev => [...prev, data]); setNewTask(""); }
    else alert(data.error || "Error adding task");
  };

  const startEditTask = (t) => { setEditingTaskId(t.id); setEditingTaskTitle(t.title); };
  const saveEditTask = async () => {
    if (!editingTaskTitle.trim()) return;
    const res = await fetch(`${API_URL}/tasks/${editingTaskId}`, {
      method: "PUT", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ title: editingTaskTitle })
    });
    const data = await res.json();
    if (res.ok) {
      setTasks(tasks.map(t => t.id===data.id ? data : t));
      setEditingTaskId(null); setEditingTaskTitle("");
    } else alert(data.error || "Error editing task");
  };

  const deleteTask = async (id) => {
    if (!confirm("Delete this task and its comments?")) return;
    const res = await fetch(`${API_URL}/tasks/${id}`, { method: "DELETE" });
    if (res.ok) {
      setTasks(tasks.filter(t => t.id !== id));
      if (selectedTask === id) { setSelectedTask(null); setComments([]); }
    } else {
      const data = await res.json().catch(()=>({})); alert(data.error || "Error deleting");
    }
  };

  const loadComments = async (taskId) => {
    const res = await fetch(`${API_URL}/tasks/${taskId}/comments`);
    const data = await res.json();
    setComments(data); setSelectedTask(taskId);
  };

  const addComment = async () => {
    if (!newComment.trim()) return;
    const res = await fetch(`${API_URL}/tasks/${selectedTask}/comments`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ content: newComment, author })
    });
    const data = await res.json();
    if (res.ok) { setComments(prev=>[...prev,data]); setNewComment(""); setAuthor(""); }
    else alert(data.error || "Error adding comment");
  };

  const startEditComment = (c) => { setEditingCommentId(c.id); setEditingCommentText(c.content); };
  const saveEditComment = async () => {
    if (!editingCommentText.trim()) return;
    const res = await fetch(`${API_URL}/tasks/${selectedTask}/comments/${editingCommentId}`, {
      method: "PUT", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ content: editingCommentText })
    });
    const data = await res.json();
    if (res.ok) {
      setComments(comments.map(x => x.id===data.id ? data : x));
      setEditingCommentId(null); setEditingCommentText("");
    } else alert(data.error || "Error editing comment");
  };

  const deleteComment = async (cid) => {
    if (!confirm("Delete this comment?")) return;
    const res = await fetch(`${API_URL}/tasks/${selectedTask}/comments/${cid}`, { method: "DELETE" });
    if (res.ok) setComments(comments.filter(c => c.id !== cid));
    else { const d = await res.json().catch(()=>({})); alert(d.error || "Error deleting"); }
  };

  return (
    <div className="app-container">
      {showIntro && <IntroModal onClose={() => { setShowIntro(false); try{localStorage.setItem("seenIntro","1")}catch{} }} />}

      <header className="header">
        <div className="title">
          <span className="logo">üß†</span>
          <div>
            <h1>Task & Comment Manager</h1>
            <div className="subtitle">Full-stack demo ‚Äî Flask API + React UI</div>
          </div>
        </div>

        <div className="controls">
          <button className="theme-btn" onClick={()=>setDarkMode(dm=>!dm)}>{darkMode ? "‚òÄÔ∏è Light" : "üåô Dark"}</button>
        </div>
      </header>

      <main className="content">
        <section className="task-section">
          <h2>Tasks</h2>
          <div className="input-group">
            <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Enter new task..." />
            <button className="primary" onClick={addTask}>Add</button>
          </div>

          <ul className="task-list">
            {tasks.map(t => (
              <li key={t.id} onClick={()=>loadComments(t.id)} className={selectedTask===t.id ? "selected animated" : ""}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                  {editingTaskId===t.id ? (
                    <div style={{flex:1, display:'flex', gap:8}}>
                      <input value={editingTaskTitle} onChange={e=>setEditingTaskTitle(e.target.value)} />
                      <button onClick={saveEditTask} className="primary small">Save</button>
                      <button onClick={()=>{setEditingTaskId(null); setEditingTaskTitle("")}}>Cancel</button>
                    </div>
                  ) : (
                    <>
                      <div>
                        <h3>{t.title}</h3>
                        <p className="muted">{new Date(t.created_at).toLocaleString()}</p>
                      </div>
                      <div style={{display:'flex', gap:8}}>
                        <button onClick={(e)=>{ e.stopPropagation(); startEditTask(t); }} className="small">Edit</button>
                        <button onClick={(e)=>{ e.stopPropagation(); deleteTask(t.id); }} className="small danger">Delete</button>
                      </div>
                    </>
                  )}
                </div>
              </li>
            ))}
            {tasks.length===0 && <div className="muted">No tasks yet ‚Äî add one above.</div>}
          </ul>
        </section>

        <section className="comment-section">
          <h2>Comments</h2>

          {selectedTask ? (
            <>
              <div className="input-group">
                <input placeholder="Your name" value={author} onChange={e=>setAuthor(e.target.value)} />
                <input placeholder="Write a comment..." value={newComment} onChange={e=>setNewComment(e.target.value)} />
                <button className="primary" onClick={addComment}>Post</button>
              </div>

              <div className="comment-list">
                {comments.map(c => (
                  <div key={c.id} className="comment-card">
                    {editingCommentId===c.id ? (
                      <div style={{display:'flex', gap:8}}>
                        <input value={editingCommentText} onChange={e=>setEditingCommentText(e.target.value)} />
                        <button onClick={saveEditComment} className="primary small">Save</button>
                        <button onClick={()=>{setEditingCommentId(null); setEditingCommentText("");}}>Cancel</button>
                      </div>
                    ) : (
                      <>
                        <p className="comment-text">{c.content}</p>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                          <p className="comment-meta">‚Äî {c.author || "Anonymous"} ‚Ä¢ {new Date(c.created_at).toLocaleString()}</p>
                          <div style={{display:'flex', gap:8}}>
                            <button onClick={()=>startEditComment(c)} className="small">Edit</button>
                            <button onClick={()=>deleteComment(c.id)} className="small danger">Delete</button>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                ))}
                {comments.length===0 && <div className="muted">No comments ‚Äî be the first!</div>}
              </div>
            </>
          ) : <p className="no-task">Select a task to view comments</p>}
        </section>
      </main>

      <footer>Made with ‚ù§Ô∏è by Mohd Zaid</footer>
    </div>
  );
}
